# For documentation see here - https://www.serverless.com/framework/docs/providers/aws/guide/serverless.yml
service: uec-dos-integration
frameworkVersion: "3"
configValidationMode: error

provider:
  name: aws
  deploymentMethod: direct
  lambdaHashingVersion: 20201221
  architecture: arm64
  region: ${env:AWS_REGION}
  versionFunctions: false
  deploymentBucket:
    blockPublicAccess: true
    skipPolicySetup: true
    versioning: true
    serverSideEncryption: aws:kms
    sseKMSKeyId: ${env:TERRAFORM_KMS_KEY_ID}
  stackTags:
    BUILD_TIMESTAMP: ${env:VERSION}
    BlueGreenEnvironment: ${env:BLUE_GREEN_ENVIRONMENT}
    DataClassification: ${env:PROJECT_DATA_CLASSIFICATION}
    EnvironmentType: ${env:AWS_ACCOUNT_NAME}
    Owner: ${env:PROJECT_DISTRIBUTION_LIST}
    Product: ${env:PROJECT_ID}
    Profile: ${env:PROFILE}
    Programme: ${env:PROGRAMME}
    Project: ${env:PROJECT_DISPLAY_NAME}
    PublicFacing: "No"
    Service: ${env:PROJECT_ID}
    ServiceCategory: ${env:PROJECT_SERVICE_CATEGORY}
    SharedEnvironment: ${env:SHARED_ENVIRONMENT}
    TagVersion: "2.0"
    Tool: "Serverless Framework deployed by CloudFormation"
  tags:
    BUILD_TIMESTAMP: ${env:VERSION}
    BlueGreenEnvironment: ${env:BLUE_GREEN_ENVIRONMENT}
    DataClassification: ${env:PROJECT_DATA_CLASSIFICATION}
    Environment: ${env:AWS_ACCOUNT_NAME}
    Owner: ${env:PROJECT_DISTRIBUTION_LIST}
    Product: ${env:PROJECT_ID}
    Profile: ${env:PROFILE}
    Programme: ${env:PROGRAMME}
    Project: ${env:PROJECT_DISPLAY_NAME}
    PublicFacing: "No"
    Service: ${env:PROJECT_ID}
    ServiceCategory: ${env:PROJECT_SERVICE_CATEGORY}
    SharedEnvironment: ${env:SHARED_ENVIRONMENT}
    TagVersion: "2.0"
    Tool: "Serverless Framework deployed by CloudFormation"
  environment:
    PROFILE: ${env:PROFILE}
    ENV: ${env:BLUE_GREEN_ENVIRONMENT}
    SHARED_ENVIRONMENT: ${env:SHARED_ENVIRONMENT}
    POWERTOOLS_SERVICE_NAME: ${env:PROGRAMME}-${env:TEAM_ID}-${env:PROFILE}-${sls:stage}
    POWERTOOLS_TRACER_CAPTURE_RESPONSE: true
    POWERTOOLS_TRACER_CAPTURE_ERROR: true
    POWERTOOLS_TRACE_MIDDLEWARES: true
    LOG_LEVEL: ${env:LOG_LEVEL}
    IMAGE_VERSION: ${env:VERSION}
  logs:
    restApi:
      format: '{"requestTime":"$context.requestTime","requestId":"$context.requestId","httpMethod":"$context.httpMethod","path":"$context.path","resourcePath":"$context.resourcePath","status":"$context.status","responseLatency":"$context.responseLatency","xrayTraceId":"$context.xrayTraceId","integrationRequestId":"$context.integration.requestId","functionResponseStatus":"$context.integration.status","integrationLatency":"$context.integration.latency","integrationServiceStatus":"$context.integration.integrationStatus","ip":"$context.identity.sourceIp","userAgent":"$context.identity.userAgent"}'
  tracing:
    lambda: true
  disableRollback: ${env:SERVERLESS_DISABLE_ROLLBACK}

plugins:
  - serverless-vpc-discovery
  - serverless-plugin-ifelse

custom:
  serverlessIfElse:
    - If: '"${env:PROFILE}" == "live"'
      Exclude:
        - functions.dos-db-handler
    - If: '"${env:PROFILE}" == "perf"'
      Exclude:
        - functions.dos-db-handler
    - If: '"${env:PROFILE}" == "perf2"'
      Exclude:
        - functions.dos-db-handler

functions:
  change-event-dlq-handler:
    image: ${env:DOCKER_REGISTRY}/${env:CHANGE_EVENT_DLQ_HANDLER}:${env:VERSION}
    name: ${env:CHANGE_EVENT_DLQ_HANDLER_LAMBDA}
    description: ${sls:stage} Change Event DLQ Handler
    memorySize: 128
    timeout: 30
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/${env:TF_VAR_change_event_dlq_handler_role}
    environment:
      CHANGE_EVENTS_TABLE_NAME: ${env:TF_VAR_change_events_table_name}
    maximumRetryAttempts: 0

  dos-db-handler:
    image: ${env:DOCKER_REGISTRY}/${env:DOS_DB_HANDLER}:${env:VERSION}
    name: ${env:DOS_DB_HANDLER_LAMBDA}
    description: ${sls:stage} DoS DB Handler for accessing DoS DB in Non-Live environments
    memorySize: 128
    timeout: 30
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/${env:TF_VAR_dos_db_handler_role}
    environment:
      DB_NAME: ${env:DB_NAME}
      DB_PORT: ${env:DB_PORT}
      DB_READ_ONLY_USER_NAME: ${env:DB_READ_ONLY_USER_NAME}
      DB_READER_SECRET_NAME: ${env:DB_READER_SECRET_NAME}
      DB_READER_SECRET_KEY: ${env:DB_READER_SECRET_KEY}
      DB_READER_SERVER: ${env:DB_READER_SERVER}
      DB_WRITER_SERVER: ${env:DB_WRITER_SERVER}
      DB_SCHEMA: ${env:DB_SCHEMA}
      DB_WRITER_SECRET_KEY: ${env:DOS_DEPLOYMENT_SECRETS_PASSWORD_KEY}
      DB_WRITER_SECRET_NAME: ${env:DOS_DEPLOYMENT_SECRETS}
      DB_READ_AND_WRITE_USER_NAME: ${env:DOS_DB_HANDLER_DB_READ_AND_WRITE_USER_NAME}
    maximumRetryAttempts: 0
    vpcDiscovery:
      vpcName: "${env:AWS_VPC_NAME}"
      subnets:
        - tagKey: Name
          tagValues:
            - "${env:AWS_VPC_NAME}-private-${env:AWS_REGION}a"
            - "${env:AWS_VPC_NAME}-private-${env:AWS_REGION}b"
            - "${env:AWS_VPC_NAME}-private-${env:AWS_REGION}c"
      securityGroups:
        - tagKey: Name
          tagValues:
            - "${env:TF_VAR_lambda_security_group_name}"

  dos-db-update-dlq-handler:
    image: ${env:DOCKER_REGISTRY}/${env:DOS_DB_UPDATE_DLQ_HANDLER}:${env:VERSION}
    name: ${env:DOS_DB_UPDATE_DLQ_HANDLER_LAMBDA}
    description: ${sls:stage} DoS DB Update DLQ Handler
    memorySize: 128
    timeout: 30
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/${env:TF_VAR_dos_db_update_dlq_handler_role}
    maximumRetryAttempts: 0

  event-replay:
    image: ${env:DOCKER_REGISTRY}/${env:EVENT_REPLAY}:${env:VERSION}
    name: ${env:EVENT_REPLAY_LAMBDA}
    description: ${sls:stage} Event Replay
    memorySize: 128
    timeout: 30
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/${env:TF_VAR_event_replay_role}
    environment:
      CHANGE_EVENTS_TABLE_NAME: ${env:TF_VAR_change_events_table_name}
      CHANGE_EVENT_SQS_NAME: ${env:TF_VAR_change_event_queue}
    maximumRetryAttempts: 0

  ingest-change-event:
    image: ${env:DOCKER_REGISTRY}/${env:INGEST_CHANGE_EVENT}:${env:VERSION}
    name: ${env:INGEST_CHANGE_EVENT_LAMBDA}
    description: ${sls:stage} Ingest Change Event
    memorySize: 128
    timeout: 30
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/${env:TF_VAR_ingest_change_event_role}
    environment:
      HOLDING_QUEUE_URL: ${env:HOLDING_QUEUE_URL}
      CHANGE_EVENTS_TABLE_NAME: ${env:TF_VAR_change_events_table_name}
    maximumRetryAttempts: 2

  send-email:
    image: ${env:DOCKER_REGISTRY}/${env:SEND_EMAIL}:${env:VERSION}
    name: ${env:SEND_EMAIL_LAMBDA}
    description: ${sls:stage} Send Email
    memorySize: 128
    timeout: 30
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/${env:TF_VAR_send_email_role}
    environment:
      AWS_ACCOUNT_NAME: ${env:AWS_ACCOUNT_NAME}
      SYSTEM_EMAIL_ADDRESS: ${env:PROJECT_SYSTEM_EMAIL_ADDRESS}
      EMAIL_SECRET_NAME: ${env:PROJECT_DEPLOYMENT_SECRETS}
    maximumRetryAttempts: 2

  service-matcher:
    image: ${env:DOCKER_REGISTRY}/${env:SERVICE_MATCHER}:${env:VERSION}
    name: ${env:SERVICE_MATCHER_LAMBDA}
    description: ${sls:stage} Service Matcher
    memorySize: 192
    timeout: 10
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/${env:TF_VAR_service_matcher_role}
    maximumRetryAttempts: 0
    reservedConcurrency: ${env:SERVICE_MATCHER_MAX_CONCURRENCY}
    environment:
      CHANGE_EVENTS_TABLE_NAME: ${env:TF_VAR_change_events_table_name}
      UPDATE_REQUEST_QUEUE_URL: ${env:UPDATE_REQUEST_QUEUE_URL}
      DB_NAME: ${env:DB_NAME}
      DB_PORT: ${env:DB_PORT}
      DB_READ_ONLY_USER_NAME: ${env:DB_READ_ONLY_USER_NAME}
      DB_READER_SECRET_NAME: ${env:DB_READER_SECRET_NAME}
      DB_READER_SECRET_KEY: ${env:DB_READER_SECRET_KEY}
      DB_READER_SERVER: ${env:DB_READER_SERVER}
      DB_SCHEMA: ${env:DB_SCHEMA}
      PHARMACY_FIRST_PHASE_ONE_PARAMETER: ${env:PHARMACY_FIRST_PHASE_ONE_PARAMETER}
    vpcDiscovery:
      vpcName: "${env:AWS_VPC_NAME}"
      subnets:
        - tagKey: Name
          tagValues:
            - "${env:AWS_VPC_NAME}-private-${env:AWS_REGION}a"
            - "${env:AWS_VPC_NAME}-private-${env:AWS_REGION}b"
            - "${env:AWS_VPC_NAME}-private-${env:AWS_REGION}c"
      securityGroups:
        - tagKey: Name
          tagValues:
            - "${env:TF_VAR_lambda_security_group_name}"

  service-sync:
    image: ${env:DOCKER_REGISTRY}/${env:SERVICE_SYNC}:${env:VERSION}
    name: ${env:SERVICE_SYNC_LAMBDA}
    description: ${sls:stage} Service Sync
    memorySize: 512
    timeout: 20
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/${env:TF_VAR_service_sync_role}
    environment:
      CHANGE_EVENTS_TABLE_NAME: ${env:TF_VAR_change_events_table_name}
      UPDATE_REQUEST_QUEUE_URL: ${env:UPDATE_REQUEST_QUEUE_URL}
      DB_NAME: ${env:DB_NAME}
      DB_PORT: ${env:DB_PORT}
      DB_READ_ONLY_USER_NAME: ${env:DB_READ_ONLY_USER_NAME}
      DB_READER_SECRET_NAME: ${env:DB_READER_SECRET_NAME}
      DB_READER_SECRET_KEY: ${env:DB_READER_SECRET_KEY}
      DB_READER_SERVER: ${env:DB_READER_SERVER}
      DB_WRITER_SERVER: ${env:DB_WRITER_SERVER}
      DB_SCHEMA: ${env:DB_SCHEMA}
      DB_WRITER_SECRET_KEY: ${env:DB_WRITER_SECRET_KEY}
      DB_WRITER_SECRET_NAME: ${env:DB_WRITER_SECRET_NAME}
      DB_READ_AND_WRITE_USER_NAME: ${env:DB_READ_AND_WRITE_USER_NAME}
      SEND_EMAIL_BUCKET_NAME: ${env:SEND_EMAIL_BUCKET_NAME}
      TEAM_EMAIL_ADDRESS: ${env:PROJECT_TEAM_EMAIL_ADDRESS}
      SYSTEM_EMAIL_ADDRESS: ${env:PROJECT_SYSTEM_EMAIL_ADDRESS}
      SEND_EMAIL_LAMBDA: ${env:TF_VAR_send_email_lambda}
    reservedConcurrency: ${env:SERVICE_SYNC_MAX_CONCURRENCY}
    maximumRetryAttempts: 0
    vpcDiscovery:
      vpcName: "${env:AWS_VPC_NAME}"
      subnets:
        - tagKey: Name
          tagValues:
            - "${env:AWS_VPC_NAME}-private-${env:AWS_REGION}a"
            - "${env:AWS_VPC_NAME}-private-${env:AWS_REGION}b"
            - "${env:AWS_VPC_NAME}-private-${env:AWS_REGION}c"
      securityGroups:
        - tagKey: Name
          tagValues:
            - "${env:TF_VAR_lambda_security_group_name}"

  slack-messenger:
    image: ${env:DOCKER_REGISTRY}/${env:SLACK_MESSENGER}:${env:VERSION}
    name: ${env:SLACK_MESSENGER_LAMBDA}
    description: ${sls:stage} Slack Messenger
    memorySize: 128
    timeout: 10
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/${env:TF_VAR_slack_messenger_role}
    environment:
      SLACK_ALERT_CHANNEL: ${env:SLACK_ALERT_CHANNEL}
      SLACK_WEBHOOK_URL: ${env:SLACK_WEBHOOK_URL}
    events:
      - sns:
          arn: arn:aws:sns:${env:AWS_REGION}:${env:AWS_ACCOUNT_ID}:${env:TF_VAR_sns_topic_app_alerts_for_slack_default_region}
      - sns:
          arn: arn:aws:sns:${env:TF_VAR_route53_health_check_alarm_region}:${env:AWS_ACCOUNT_ID}:${env:TF_VAR_sns_topic_app_alerts_for_slack_route53_health_check_alarm_region}

  quality-checker:
    image: ${env:DOCKER_REGISTRY}/${env:QUALITY_CHECKER}:${env:VERSION}
    name: ${env:QUALITY_CHECKER_LAMBDA}
    description: ${sls:stage} Quality Checker
    memorySize: 512
    timeout: 900
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/${env:TF_VAR_quality_checker_role}
    environment:
      DB_NAME: ${env:DB_NAME}
      DB_PORT: ${env:DB_PORT}
      DB_READ_ONLY_USER_NAME: ${env:DB_READ_ONLY_USER_NAME}
      DB_READER_SECRET_NAME: ${env:DB_READER_SECRET_NAME}
      DB_READER_SECRET_KEY: ${env:DB_READER_SECRET_KEY}
      DB_READER_SERVER: ${env:DB_READER_SERVER}
      DB_WRITER_SERVER: ${env:DB_WRITER_SERVER}
      DB_SCHEMA: ${env:DB_SCHEMA}
      DB_WRITER_SECRET_KEY: ${env:DB_WRITER_SECRET_KEY}
      DB_WRITER_SECRET_NAME: ${env:DB_WRITER_SECRET_NAME}
      DB_READ_AND_WRITE_USER_NAME: ${env:DB_READ_AND_WRITE_USER_NAME}
    maximumRetryAttempts: 0
    events:
      - schedule:
          name: ${env:QUALITY_CHECKER_LAMBDA}-schedule
          description: Quality Checker Schedule for triggering a DoS quality check
          rate: cron(30 4 ? * MON *)
    vpcDiscovery:
      vpcName: "${env:AWS_VPC_NAME}"
      subnets:
        - tagKey: Name
          tagValues:
            - "${env:AWS_VPC_NAME}-private-${env:AWS_REGION}a"
            - "${env:AWS_VPC_NAME}-private-${env:AWS_REGION}b"
            - "${env:AWS_VPC_NAME}-private-${env:AWS_REGION}c"
      securityGroups:
        - tagKey: Name
          tagValues:
            - "${env:TF_VAR_lambda_security_group_name}"
